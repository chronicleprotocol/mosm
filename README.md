# Mosm

Combined Median and OSM smart contract. Effectively, this combines the [median](https://github.com/chronicleprotocol/medianite) and [osm](https://github.com/makerdao/osm) contracts into a single contract so that we can realize a cost savings by changing the [contract-to-contract](https://github.com/makerdao/osm/blob/master/src/osm.sol#L133) call in `poke()`

```
function poke() {
        (bytes32 wut, bool ok) = DSValue(src).peek();
        ...
}
```

to an [internal](https://github.com/chronicleprotocol/mosm/blob/main/src/mosm.sol#L251) call:

```
function osm_poke() {
        (uint256 wut, bool ok) = this.peek();
        ...
}
```

## Build and test

To build the contract from source do

```
make all
```

In a separate terminal window, you'll want to get a testchain running.

```
dapp testnet --accounts 13
```

will start a local testnet with 13 accounts that will be used for feeds. Export all your `ETH_*` vars, e.g. `ETH_FROM`, `ETH_KEYSTORE`, etc into your environment.

Then, do

```
dapp create MosmETHUSD
```

to deploy the included ETHUSD contract. Now you're ready to test. Do

```
./test_median.sh ETHUSD <MOSM_ADDRESS_from_dapp_create_above>
```

The above will exercise the **Median** side of the contract, and set a current Median price. Now you are ready to test the **OSM** side of things. Do

```
./test_osm.sh <MOSM_ADDRESS_from_dapp_create_above>
```

And the end result is that when you call `osm_poke()` followed by `osm_peek()` the OSM reflects the same value that was generated by `test_median.sh`.


